function showMsgError(e,o){e.alerts.push({type:"danger",msg:o})}vLocNameModule.controller("LocNameController",["$scope","$rootScope","$http","$translate","LocNameStateService","wStorageService",function(e,o,a,n,t,l){"use strict";function m(o,a){l.put("cLat",o),l.put("cLng",a),e.map={center:{latitude:o,longitude:a},zoom:8},e.options={scrollwheel:!1},e.marker={id:0,coords:{latitude:o,longitude:a},options:{draggable:!1},events:{dragend:function(){}}}}function g(){var o={enableHighAccuracy:!0,timeout:5e3,maximumAge:0};r=l.get("cLat"),u=l.get("cLng"),null==r&&null==u?navigator.geolocation?navigator.geolocation.getCurrentPosition(i,d,o):(m(40.437827,-3.679537),e.alerts.push({type:"danger",msg:n.instant("LOCNAME.ERROR_CURRENT_LOC")})):m(r,u)}function s(){e.geonameID="---",e.geonameName="---",e.geonameLat="---",e.geonameLng="---",e.geonameUACode1="---",e.geonameUACode2="---",e.geonameUACode3="---",e.geonameUACode4="---",e.geonameUACode5="---",e.geonameUALevel="",e.geonameUACode=""}function i(e){r=e.coords.latitude,u=e.coords.longitude,m(r,u)}function d(){m(40.437827,-3.679537)}var c={},r=l.get("cLat"),u=l.get("cLng"),A=[];g(),m(40.437827,-3.679537),e.showGeonameButton=!1,e.autocompleteOptions={types:["geocode"]},e.initialTxtGoogle="",e.latGoogle="[ ]",e.lngGoogle="[ ]",s();var L="geonamesListNO",C="geonamesListOK";e.locListClassAdd=L,e.txtLocalizaciones=n.instant("LOCNAME.NO_AVA_LOCATIONS"),e.alerts=[];var p=l.get("un");null===p?(e.alerts.push({type:"warning",msg:n.instant("CONFIG.ERROR_NO_USER2")}),e.userNoSaved=!0):(e.alerts=[],e.userNoSaved=!1);var N=l.get("lg");null===N?(n.use("es_ES"),l.put("lg","es_ES"),N="es_ES"):n.use(N),window.document.title="es_ES"===N?"Localización por Nombre":"Places Location",o.$on("$locationChangeStart",function(o,a,n){if(-1!=n.indexOf("locname")){var l={};l.googleTxt=c.name,l.latGoogle=e.latGoogle,l.lngGoogle=e.lngGoogle,l.map=e.map,l.marker=e.marker,l.locationsList=e.places_list,l.placesList_model=e.placesList_model,l.tblGeonameID=e.geonameID,l.tblName=e.geonameName,l.tblLat=e.geonameLat,l.tblLng=e.geonameLng,l.tblNAdm1=e.geonameUACode1,l.tblNAdm2=e.geonameUACode2,l.tblNAdm3=e.geonameUACode3,l.tblNAdm4=e.geonameUACode4,l.tblNAdm5=e.geonameUACode5,l.locListClassAdd=e.locListClassAdd,l.txtLocalizaciones=e.txtLocalizaciones,t.saveData(l)}if(-1!=a.indexOf("locname")){var m=t.readData();e.initialTxtGoogle=m.googleTxt,c.name=m.googleTxt,e.latGoogle=m.latGoogle,e.lngGoogle=m.lngGoogle,e.map=m.map,e.marker=m.marker,e.places_list=m.locationsList,e.placesList_model=m.placesList_model,e.geonameID=m.tblGeonameID,e.geonameName=m.tblName,e.geonameLat=m.tblLat,e.geonameLng=m.tblLng,e.geonameUACode1=m.tblNAdm1,e.geonameUACode2=m.tblNAdm2,e.geonameUACode3=m.tblNAdm3,e.geonameUACode4=m.tblNAdm4,e.geonameUACode5=m.tblNAdm5,e.locListClassAdd=m.locListClassAdd,e.txtLocalizaciones=m.txtLocalizaciones}});e.$on("gmPlacesAutocomplete::placeChanged",function(){if("undefined"!=typeof e.autocompleteModel){var o=e.autocompleteModel.getPlace();if(o.geometry){s();var a=o.geometry.location;e.latGoogle=Number(a.lat()).toFixed(6),e.lngGoogle=Number(a.lng()).toFixed(6),e.map.center.latitude=a.lat(),e.map.center.longitude=a.lng(),e.marker.coords.latitude=a.lat(),e.marker.coords.longitude=a.lng(),c.name=o.formatted_address,c.country="",c.uAdm1="",c.uAdm2="",c.uAdm3="";for(var n=o.address_components,t=n.length,l=0,m=0;t>m;m++)if(l=n[m].types.length,l>0)for(var g=n[m].types,i=0;l>i;i++)switch(g[i]){case"administrative_area_level_1":c.uAdm1=n[m].long_name;break;case"administrative_area_level_2":c.uAdm2=n[m].long_name;break;case"administrative_area_level_3":c.uAdm3=n[m].long_name;break;case"country":c.country=n[m].short_name}e.showGeonameButton=!0,e.$apply(),e.searchGeoname()}else e.latGoogle="NO SE LOCALIZA",e.lngGoogle="NO SE LOCALIZA",e.$apply()}});e.searchGeoname=function(){var o="http://api.geonames.org/searchJSON?q=",t="&username="+p,l="&featureClass=A&featureClass=L&featureClass=P",m=c.name.split(","),g="";g=o+c.name+"&name="+m[0]+"&adminName1="+c.uAdm1+"&adminName2="+c.uAdm2+"&adminName3="+c.uAdm3+"&country="+c.country+l+t,a.get(g).success(function(o){if(null!==o.status&&void 0!==o.status)return void showMsgError(e,n.instant("UADM.ERROR_ACCESS"));if(A.splice(0,A.length),o.totalResultsCount>0){for(var a=0;a<o.totalResultsCount;a++){for(var t=!1,l=0;l<A.length;l++)if(A[l].name==o.geonames[a].name){t=!0;break}t||A.push({id:o.geonames[a].geonameId,name:o.geonames[a].name})}e.locListClassAdd=C,e.txtLocalizaciones=n.instant("LOCNAME.SEL_LOCATION")}else A.push({id:0,name:"No se han encontrado"}),e.locListClassAdd=L,e.txtLocalizaciones=n.instant("LOCNAME.NO_AVA_LOCATIONS"),s();e.places_list=A}).error(function(){showMsgError(e,n.instant("UADM.ERROR_ACCESS"))})},e.searchLatLongGeoname=function(){var o="http://api.geonames.org/findNearbyPlaceNameJSON?",n="http://api.geonames.org/getJSON?",t="&username="+p,l=o+"lat="+e.latGoogle+"&lng="+e.lngGoogle+t;a.get(l).success(function(o){console.log(l),console.log(o),e.geonameID=o.geonames[0].geonameId,e.geonameName=o.geonames[0].name,e.geonameLat=o.geonames[0].lat,e.geonameLng=o.geonames[0].lng,l=n+"id="+e.geonameID+t,a.get(l).success(function(o){e.geonameUACode1=o.adminCode1,e.geonameUACode2=o.adminCode2,e.geonameUACode3=o.adminCode3,e.geonameUACode4=o.adminCode4,e.geonameUACode5=o.adminCode5,e.map.center.latitude=e.geonameLat,e.map.center.longitude=e.geonameLng,e.marker.coords.latitude=e.geonameLat,e.marker.coords.longitude=e.geonameLng})})},e.searchGeocoderGoogle=function(){var e="http://maps.googleapis.com/maps/api/geocode/json?address=",o=e+c.name+"&sensor=false";a.get(o).success(function(){})},e.getGeonameByID=function(){var o="http://api.geonames.org/getJSON?geonameId=",n="&username="+p,t=o+e.placesList_model.id+n;a.get(t).success(function(o){e.geonameID=o.geonameId,e.geonameName=o.name,e.geonameLat=o.lat,e.geonameLng=o.lng,e.geonameUACode1=o.adminCode1,e.geonameUACode2=o.adminCode2,e.geonameUACode3=o.adminCode3,e.geonameUACode4=o.adminCode4,e.geonameUACode5=o.adminCode5,e.map.center.latitude=e.geonameLat,e.map.center.longitude=e.geonameLng,e.marker.coords.latitude=e.geonameLat,e.marker.coords.longitude=e.geonameLng})},o.$on("$translateChangeSuccess",function(){var e=l.get("lg");window.document.title="es_ES"===e?"Places location":"Localización por Nombre"}),e.deleteTxtGoogle=function(){var o=document.getElementById("frmLocName");o.value="",e.initialTxtGoogle="",g(),e.latGoogle="[ ]",e.lngGoogle="[ ]",s(),e.places_list={},e.txtLocalizaciones=n.instant("LOCNAME.NO_AVA_LOCATIONS"),e.locListClassAdd=L}}]);